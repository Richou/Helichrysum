<!doctype html>
<html lang="fr">
<head>
	<meta charset="UTF-8" />
    <title>RoseMary</title>
	<link rel="stylesheet" type="text/css" href="./styles/rosemary.css" />
</head>
<body>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
	<script src="./js/core.js"></script>
	<script type="text/javascript">
		$(document).ready(function(){
			$('#createAlbumForm').on('submit', function(e){
				
				var albumId = $("#createAlbumForm input[name=albumsId]").val();
				var albumNom = $("#createAlbumForm input[name=albumsNom]").val();
				var songsString = $.trim($("#createAlbumForm textarea[name=albumsSongs]").val());
				var datas = {};
				if(albumId != ''){
					datas["id"] = albumId;
				}
				datas["nom"] = albumNom;
				datas["songs"] = songsString.split('\n');
				$.ajax({
					url: API_URL + "_ah/api/helichrysum/v1/albums/create",
					dataType: 'json',
					type: "POST",
					contentType: "application/json, charset=utf-8",
					data: JSON.stringify(datas),
					beforeSend: function(e){
						$('#throbber').show();
					},
					success: function(result){
						$('#createAlbumForm input[type=text]').val("");
						$('#createAlbumForm textarea[name=albumsSongs]').val("");
						$('#throbber').hide();
					},
					error:function(jqXHR, textStatus, errorThrown){
						console.log(errorThrown);
					}
				});
				e.preventDefault();
				return false;
			});
			
			// En mode edit on a l'id donc on remplis les champs
			if(getParam('id') != null){
				$.ajax({
					url: API_URL + "_ah/api/helichrysum/v1/albums/see/" + getParam('id'),
					dataType: 'json',
					type: "GET",
					contentType: "application/json, charset=utf-8",
					beforeSend: function(e){
						$('#throbber').show();
					},
					success: function(result){
						$("#createAlbumForm input[name=albumsId]").val(result.id);
						$("#createAlbumForm input[name=albumsNom]").val(result.nom);
						var songs = result.songs;
						var textSongs = "";
						$(songs).each(function(i, song){
							textSongs += song + "\n";
						});
						$("#createAlbumForm textarea[name=albumsSongs]").val($.trim(textSongs));
						$('#throbber').hide();
					},
					error:function(jqXHR, textStatus, errorThrown){
						console.log(errorThrown);
					}
				});
			}
		});
	</script>
	
	<div id="content">
		<h3>Ajouter un nouvel album<span id="throbber" class="throbber"><img src="./img/wait.gif" alt="Chargement en cours"/></span><span class="right add"><a href="index.html">Voir</a></span></h3>
		<form id="createAlbumForm" method="post">
			<input type="hidden" name="albumsId" /><br />
			<label>Nom</label>
			<input type="text" placeholder="Entrer le nom d'un album" required name="albumsNom"/><br />
			<label>Chansons<br /><span class="tooltip">Liste des chansons séparé par des retours chariot</span></label>
			<textarea name="albumsSongs" placeholder="Saisir la liste des chansons" required></textarea>
			<input type="submit" value="Enregistrer" class="b-j button-bg"/>
		</form>
	</div>

</body>
</html>